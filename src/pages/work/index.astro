---
import { getCollection } from "astro:content";
import PageLayout from "@layouts/PageLayout.astro";
import Container from "@components/Container.astro";
import { dateRange } from "@lib/utils";
import { WORK } from "@consts";
import { getLangFromUrl, useTranslations } from "@i18n/ui";

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

// Company metadata with logos and LinkedIn links
const companyMeta: Record<string, { logo: string; linkedin: string }> = {
  "TestBox": {
    logo: "/testbox_logo.png",
    linkedin: "https://www.linkedin.com/company/testboxofficial"
  },
  "Lumenalta (formerly Clevertech)": {
    logo: "/clevertech_logo.jpeg",
    linkedin: "https://www.linkedin.com/company/lumenalta"
  },
  "Lumenalta (anteriormente Clevertech)": {
    logo: "/clevertech_logo.jpeg",
    linkedin: "https://www.linkedin.com/company/lumenalta"
  },
  "Develcode": {
    logo: "/develcode_logo.jpeg",
    linkedin: "https://www.linkedin.com/company/develcode"
  },
  "Concordia Labs": {
    logo: "/concordia_labs_logo.jpeg",
    linkedin: "https://www.linkedin.com/company/concordia-labs"
  },
  "Dipsystem": {
    logo: "/dipsystem.jpeg",
    linkedin: "https://www.linkedin.com/in/dipsystem-sistemas-8960241ab/"
  },
};

// Use appropriate collection based on language
const workCollection = lang === "pt" ? "work-pt" : "work";
const collection = (await getCollection(workCollection))
  .sort((a, b) => new Date(b.data.dateStart).valueOf() - new Date(a.data.dateStart).valueOf());

const work = await Promise.all(
  collection.map(async (item) => {
    const { Content } = await item.render();
    return { ...item, Content };
  })
);

// Group work entries by company
const groupedWork = work.reduce((acc, entry) => {
  const companyName = entry.data.company;
  if (!acc[companyName]) {
    acc[companyName] = [];
  }
  acc[companyName].push(entry);
  return acc;
}, {} as Record<string, typeof work>);

// Convert to array and sort by most recent role start date
const companies = Object.entries(groupedWork)
  .map(([company, roles]) => {
    // Sort roles within company by start date (most recent first)
    const sortedRoles = roles.sort((a, b) =>
      new Date(b.data.dateStart).valueOf() - new Date(a.data.dateStart).valueOf()
    );

    // Get company-wide date range
    const earliestStart = roles.reduce((earliest, role) => {
      const roleStart = new Date(role.data.dateStart);
      return roleStart < earliest ? roleStart : earliest;
    }, new Date(roles[0].data.dateStart));

    const latestEnd = roles.reduce((latest, role) => {
      if (role.data.dateEnd === "Current") return new Date();
      const roleEnd = new Date(role.data.dateEnd);
      return roleEnd > latest ? roleEnd : latest;
    }, roles[0].data.dateEnd === "Current" ? new Date() : new Date(roles[0].data.dateEnd));

    return {
      company,
      roles: sortedRoles,
      dateStart: earliestStart,
      dateEnd: roles.some(r => r.data.dateEnd === "Current") ? "Current" : latestEnd,
      hasMultipleRoles: roles.length > 1,
      meta: companyMeta[company]
    };
  })
  .sort((a, b) => new Date(b.dateStart).valueOf() - new Date(a.dateStart).valueOf());
---

<PageLayout title={WORK.TITLE} description={WORK.DESCRIPTION}>
  <Container>
    <div class="space-y-10">
      <div class="animate font-semibold text-black dark:text-white">
        {t("work.title")}
      </div>
      <ul class="flex flex-col space-y-8">
        {
          companies.map(({ company, roles, dateStart, dateEnd, hasMultipleRoles, meta }) => (
            <li class="animate">
              {/* Company header */}
              <div class="mb-3 flex items-center gap-3">
                {meta && (
                  <a 
                    href={meta.linkedin} 
                    target="_blank" 
                    rel="noopener noreferrer"
                    class="flex-shrink-0 hover:opacity-80 transition-opacity"
                  >
                    <img 
                      src={meta.logo} 
                      alt={`${company} logo`}
                      class="w-10 h-10 rounded-full object-cover"
                    />
                  </a>
                )}
                <div class="flex-1 min-w-0">
                  <div class="flex flex-wrap items-baseline gap-x-2">
                    {meta ? (
                      <a 
                        href={meta.linkedin} 
                        target="_blank" 
                        rel="noopener noreferrer"
                        class="font-semibold text-black dark:text-white text-lg hover:underline"
                      >
                        {company}
                      </a>
                    ) : (
                      <span class="font-semibold text-black dark:text-white text-lg">
                        {company}
                      </span>
                    )}
                    {!hasMultipleRoles && (
                      <>
                        <span class="text-zinc-400 dark:text-zinc-500">路</span>
                        <span class="text-sm text-black dark:text-white">
                          {roles[0].data.role}
                        </span>
                        <span class="text-zinc-400 dark:text-zinc-500">路</span>
                        <span class="text-sm opacity-75">
                          {dateRange(roles[0].data.dateStart, roles[0].data.dateEnd, lang)}
                        </span>
                      </>
                    )}
                    {hasMultipleRoles && (
                      <>
                        <span class="text-zinc-400 dark:text-zinc-500">路</span>
                        <span class="text-sm opacity-75">
                          {dateRange(dateStart, dateEnd, lang)}
                        </span>
                      </>
                    )}
                  </div>
                </div>
              </div>

              {/* Roles */}
              {hasMultipleRoles ? (
                <ul class="ml-[52px] space-y-4 border-l-2 border-gray-300 dark:border-gray-700 pl-4">
                  {roles.map(entry => (
                    <li>
                      <div class="flex flex-wrap items-baseline gap-x-2">
                        <span class="font-medium text-black dark:text-white">
                          {entry.data.role}
                        </span>
                        <span class="text-zinc-400 dark:text-zinc-500">路</span>
                        <span class="text-sm opacity-75">
                          {dateRange(entry.data.dateStart, entry.data.dateEnd, lang)}
                        </span>
                      </div>
                      <article>
                        <entry.Content />
                      </article>
                    </li>
                  ))}
                </ul>
              ) : (
                <div class="ml-[52px]">
                  {roles.map(entry => (
                    <article>
                      <entry.Content />
                    </article>
                  ))}
                </div>
              )}
            </li>
          ))
        }
      </ul>
    </div>
  </Container>
</PageLayout>