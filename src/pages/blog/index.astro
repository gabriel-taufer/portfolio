---
import PageLayout from "@layouts/PageLayout.astro";
import Container from "@components/Container.astro";
import Link from "@components/Link.astro";
import { getLangFromUrl, useTranslations } from "@i18n/ui";

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

// Fetch RSS feed from poorthoughts.com
let posts: Array<{
  title: string;
  link: string;
  pubDate: string;
  description: string;
}> = [];

try {
  const response = await fetch('https://poorthoughts.com/rss.xml');
  const xml = await response.text();

  // Simple XML parsing for RSS
  const itemRegex = /<item>(.*?)<\/item>/gs;
  const titleRegex = /<title>(.*?)<\/title>/s;
  const linkRegex = /<link>(.*?)<\/link>/s;
  const pubDateRegex = /<pubDate>(.*?)<\/pubDate>/s;
  const descriptionRegex = /<description>(.*?)<\/description>/s;

  const items = xml.match(itemRegex) || [];

  posts = items.map(item => {
    const titleMatch = item.match(titleRegex);
    const linkMatch = item.match(linkRegex);
    const pubDateMatch = item.match(pubDateRegex);
    const descriptionMatch = item.match(descriptionRegex);

    // Decode HTML entities
    const decodeHTML = (text: string) => {
      return text
        .replace(/&apos;/g, "'")
        .replace(/&quot;/g, "\"")
        .replace(/&lt;/g, "<")
        .replace(/&gt;/g, ">")
        .replace(/&amp;/g, "&");
    };

    return {
      title: titleMatch ? decodeHTML(titleMatch[1]) : "",
      link: linkMatch ? linkMatch[1] : "",
      pubDate: pubDateMatch ? pubDateMatch[1] : "",
      description: descriptionMatch ? decodeHTML(descriptionMatch[1]).replace(/<[^>]*>/g, "").substring(0, 200) : ""
    };
  }).filter(post => post.title && post.link);
} catch (error) {
  console.error('Error fetching blog posts:', error);
}

function formatDate(dateString: string) {
  const date = new Date(dateString);
  return date.toLocaleDateString(lang === 'pt' ? 'pt-BR' : 'en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });
}
---

<PageLayout title={t('nav.blog')} description="Blog posts from Poor Thoughts">
  <Container>
    <div class="space-y-10">
      <div class="flex flex-col items-center gap-6">
        <div class="animate text-black dark:text-white text-center text-2xl font-serif">
          Poor Thoughts
        </div>
        <p class="text-center opacity-75 italic text-sm">
          {lang === "pt" ? "esse é o blog onde eu escrevo, disponível apenas em inglês" : "this is the blog where I write"}
        </p>
      </div>

      <section class="animate space-y-6">
        {posts.length === 0 ? (
          <p class="text-center opacity-75">
            {lang === 'pt' ? 'Nenhum post encontrado.' : 'No posts found.'}
          </p>
        ) : (
          <ul class="space-y-8">
            {posts.map(post => (
              <li class="space-y-2">
                <div class="text-sm opacity-75">
                  {formatDate(post.pubDate)}
                </div>
                <Link href={post.link} external>
                  <h3 class="font-semibold text-lg text-black dark:text-white hover:underline">
                    {post.title}
                  </h3>
                </Link>
                {post.description && (
                  <p class="opacity-75">
                    {post.description}...
                  </p>
                )}
              </li>
            ))}
          </ul>
        )}
      </section>

      <div class="text-center">
        <Link href="https://poorthoughts.com" external>
          {lang === 'pt' ? 'Visite o blog completo →' : 'Visit full blog →'}
        </Link>
      </div>
    </div>
  </Container>
</PageLayout>
